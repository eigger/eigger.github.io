<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gicisky Image Uploader</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap');
    :root {
      --bg-color: #f8f9fa;
      --text-color: #333;
      --primary-color: #007bff;
      --secondary-color: #555;
      --button-bg: #000000;
      --button-hover: #5e5d5d;
      --container-bg: white;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --status-bg: #f3f3f3;
    }
    [data-theme="dark"] {
      --bg-color: #121212;
      --text-color: #f8f9fa;
      --primary-color: #90caf9;
      --secondary-color: #ccc;
      --button-bg: #3f3f3f;
      --button-hover: #a0a0a0;
      --container-bg: #1e1e1e;
      --shadow-color: rgba(255, 255, 255, 0.1);
      --status-bg: #333;
    }
    body {
      font-family: 'Nanum Gothic', sans-serif;
      text-align: center;
      margin: 20px;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    h1, h2 {
      color: var(--primary-color);
      margin-bottom: 10px;
      font-size: 20px;
    }
    label {
      font-weight: bold;
      margin-right: 5px;
      color: var(--secondary-color);
      font-size: 14px;
    }
    label.info {
      font-size: 13px;
      margin: 10px;
    }
    input,
    select,
    button {
      padding: 8px;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    input, select {
      max-width: 300px;
      min-width: 200px;
      text-align: center;
      color: var(--text-color);
      background-color: var(--bg-color);
    }
    button {
      width: 200px;
      background-color: var(--button-bg);
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s;
      border: none;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    button:hover {
      background-color: var(--button-hover);
    }
    button:disabled:hover {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #ble-support {
      color: red;
      font-weight: bold;
    }
    .container {
      max-width: 450px;
      margin: 0 auto;
      background: var(--container-bg);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0px 0px 10px var(--shadow-color);
    }
    .step-container {
      text-align: left;
      max-width: 450px;
      margin: 5px auto;
      background: var(--container-bg);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0px 0px 10px var(--shadow-color);
    }
    .image-container {
      border: 0.5px solid rgb(231, 231, 231);
      max-width: 350px;
      margin: 5px auto;
      background: white;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0px 0px 10px var(--shadow-color);
    }
    .select-label {
      margin: 10px 0;
      text-align: center;
    }
    .send-image {
      margin: 10px 0;
      text-align: center;
    }

    canvas {
      border: 1px solid rgb(204, 203, 203);
      display: block;
      margin: 10px auto;
    }
    .file-upload {
      text-align: center;
    }
    #pixelData {
      display: none;
    }
    .log-view {
      margin: 10px 0;
      text-align: center;
      display: block;
    }
    #status {
      text-align: left;
      padding: 10px;
      border-radius: 5px;
      background-color: var(--status-bg);
      color: var(--text-color);
      font-size: 12px;
      margin-top: 10px;
    }
    #log {
      text-align: left;
      padding: 10px;
      border-radius: 5px;
      background-color: var(--status-bg);
      color: var(--text-color);
      font-size: 12px;
      margin-top: 10px;
      height: 100px;
      overflow: auto;
    }
    .pixlr-button {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 15px;
      text-decoration: none;
      border-radius: 5px;
      transition: background-color 0.3s;
      border: none;
      font-size: 12px;
      cursor: pointer;
    }
    .theme-container {
      display: flex;
      justify-content: space-evenly;
      align-items: center;
    }
    .theme-toggle {
      width: 50px;
      font-size: 24px;
      cursor: pointer;
      border: none;
      background: none;
    }
    .slider-container {
      margin: 10px 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
    }
    .slider-container label {
      font-size: 14px;
      width: 150px;
    }
  </style>
</head>
<body data-theme="light">
  <div class="container">
    <!-- í…Œë§ˆ ë° ì œëª© ì˜ì—­ -->
    <div class="theme-container">
      <h1>ì „ì ë¼ë²¨ (Gicisky) Image Uploader</h1>
      <button class="theme-toggle" id="themeToggle">â˜€ï¸</button>
    </div>
    <div class="info">
      <div id="ble-support"></div>
    </div>

    <!-- ë¼ë²¨ íƒ€ì… ì„ íƒ (í•­ìƒ ë³´ì„) -->
    <div class="step-container">
      <label>1 ë‹¨ê³„ : ë¼ë²¨ íƒ€ì…ì„ ì„ íƒ í•˜ì„¸ìš”.</label>
      <div class="select-label">
        <select id="optionsSelect">
          <option value="410B">250x122 (2.1ì¸ì¹˜) ê²€ì • & í°ìƒ‰ & ë¹¨ê°•</option>
          <option value="40A0">250x132 (2.1ì¸ì¹˜) ê²€ì •</option>
        </select>
      </div>
    </div>

    <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
    <div class="step-container">
      <label>2 ë‹¨ê³„ : ì—…ë¡œë“œ í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒ í•˜ì„¸ìš”.</label>
      <div class="file-upload">
        <input type="file" id="imageUpload" accept="image/*">
        <button class="pixlr-button" id="pixlrButton">ì›¹ ì´ë¯¸ì§€ ì—ë””í„° (í•„ìš”ì‹œ)</button>
      </div>
    </div>

    <!-- Width & Height ì„¤ì • -->
    <div style="display: none;">
        <label for="widthInput">Width:</label>
        <input type="text" id="widthInput" value="250" style="width: 50px;">
        <label for="heightInput">Height:</label>
        <input type="text" id="heightInput" value="128" style="width: 50px;">
    </div>
  
    <!-- ì²´í¬ë°•ìŠ¤ ì˜µì…˜ -->
    <div class="options" style="display: none;">
        <label><input type="checkbox" id="ditherrin"> Dithering</label>
        <label><input type="checkbox" id="compressionCheckbox"> Compression</label>
        <label><input type="checkbox" id="secondColorCheckbox"> Second Color</label>
        <label><input type="checkbox" id="mirrorCheckbox"> Mirror</label>
        <label><input type="checkbox" id="tftCheckbox"> TFT</label>
    </div>

    <div class="step-container">
      <label>3 ë‹¨ê³„ : ì´ë¯¸ì§€ì˜ ìƒ‰ìƒì„ ì¡°ì ˆ í•˜ì„¸ìš”.</label><br>
      <label class="info">ë“œë˜ê·¸ : ì´ë™, íœ  : í™•ëŒ€ & ì¶•ì†Œ</label><br>
      <!-- ìº”ë²„ìŠ¤ ë° í¸ì§‘ ë²„íŠ¼ -->
      <div class="image-container">
        <canvas id="myCanvas" width="250" height="128"></canvas>
      </div>
      <!-- ìŠ¬ë¼ì´ë” ì»¨íŠ¸ë¡¤ -->
      <div class="slider-container">
        <label for="luminanceSlider">ê²€ì • ìƒ‰ìƒ: <span id="lumVal">128</span></label>
        <input type="range" id="luminanceSlider" min="0" max="255" value="128">
      </div>
      <div class="slider-container">
        <label for="redSlider">ë¹¨ê°• ìƒ‰ìƒ: <span id="redVal">170</span></label>
        <input type="range" id="redSlider" min="0" max="255" value="170">
      </div>
    </div>

    <!-- ìˆ¨ê¹€ í…ìŠ¤íŠ¸ì˜ì—­ (í”½ì…€ ë°ì´í„° ì €ì¥) -->
    <textarea id="pixelData"></textarea>

    <!-- BLE ì—…ë¡œë“œ ì„¹ì…˜ (í•„ìš” ì‹œ) -->
    <div class="step-container">
      <label>4 ë‹¨ê³„ : ì „ìë¼ë²¨ì— ì—°ê²°í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ í•˜ì„¸ìš”.</label><br>
      <label class="info">ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì „ìë¼ë²¨ì´ ë‚˜íƒ€ë‚ ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</label><br>
      <label class="info">ex: ì „ìë¼ë²¨ ë²ˆí˜¸ 92.12.78.64 -> NEMR92127864 ì„ íƒ</label>
      <div class="send-image">
        <button id="connectButton">ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
      </div>

      <div class="log-view">
        <!-- <button id="clearLogButton">ë¡œê·¸ ì •ë¦¬</button> -->
        <div id="status"></div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <!-- JavaScript: ê¸°ëŠ¥ë³„ ëª¨ë“ˆí™” (ìŠ¬ë¼ì´ë” ì˜¤ë²„ë ˆì´ ì ìš© ë° pixelData ê°±ì‹ ) -->
  <script>
    (function() {
      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      const Utils = {
        bufferToHex(buffer) {
          return [...new Uint8Array(buffer)]
            .map(x => x.toString(16).padStart(2, '0'))
            .join('');
        },
        hexToBytes(hex) {
          let bytes = [];
          for (let c = 0; c < hex.length; c += 2) {
            bytes.push(parseInt(hex.substr(c, 2), 16));
          }
          return new Uint8Array(bytes);
        },
        bytesToHex(data) {
          return Array.from(new Uint8Array(data))
            .map(i => ("0" + i.toString(16)).slice(-2))
            .join('');
        },
        intToHex(num) {
          const hexStr = ("00000000" + num.toString(16)).slice(-8);
          return hexStr.substring(6, 8) + hexStr.substring(4, 6) + hexStr.substring(2, 4) + hexStr.substring(0, 2);
        },
        clamp(value) {
          return Math.max(0, Math.min(255, value));
        }
      };

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ í…Œë§ˆ ê´€ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      const ThemeManager = {
        toggleTheme() {
          const body = document.body;
          const toggleBtn = document.getElementById('themeToggle');
          const currentTheme = body.getAttribute("data-theme");
          const newTheme = currentTheme === "light" ? "dark" : "light";
          body.setAttribute("data-theme", newTheme);
          toggleBtn.textContent = newTheme === "light" ? "â˜€ï¸" : "ğŸŒ™";
        }
      };

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìº”ë²„ìŠ¤ ê´€ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      const CanvasManager = {
        canvas: document.getElementById('myCanvas'),
        ctx: document.getElementById('myCanvas').getContext('2d'),
        originalImageData: null, // ì—…ë¡œë“œëœ ì›ë³¸ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ì €ì¥
        image: null,  // ë“œë˜ê·¸ ì´ë™ ë° í™•ëŒ€/ì¶•ì†Œë¥¼ ìœ„í•œ ì´ë¯¸ì§€ ì €ì¥
        scale: 1,
        newW: 0,
        newH: 0,
        offsetX: 0,
        offsetY: 0,
        initCanvas() {
          const width = parseInt(document.getElementById('widthInput')?.value || 250);
          const height = parseInt(document.getElementById('heightInput')?.value || 128);
          this.canvas.width = width;
          this.canvas.height = height;
          this.ctx.fillStyle = 'white';
          this.ctx.fillRect(0, 0, width, height);
        },
        
        decodeTypes() {
            var select = document.getElementById("optionsSelect");
            var selectedValue = select.options[select.selectedIndex].value;
            var rawType = Number("0x" + selectedValue);
            var screenResolution = (rawType >> 5) & 63;
            var dispPtype = (rawType >> 3) & 3;
            var availColors = ((rawType >> 1) & 3) + ((rawType >> 10) & 12);
            var singleDoubleMirror = rawType & 1;
            var canDoCompression = (rawType & 0x4000) ? 0 : 1;

            console.log("Display Resolution: " + screenResolution);
            console.log("Display Type: " + dispPtype);
            console.log("Display Colors: " + availColors);
            console.log("Display Mirror: " + singleDoubleMirror);
            console.log("Display Compression: " + canDoCompression);

            document.getElementById('ditherrin').checked = false;
            if (canDoCompression)
                document.getElementById('compressionCheckbox').checked = true;
            else
                document.getElementById('compressionCheckbox').checked = false;

            switch (screenResolution) {
                case 0:
                    document.getElementById('heightInput').value = "104";
                    document.getElementById('widthInput').value = "212";
                    break;
                case 1:
                    document.getElementById('heightInput').value = "128";
                    document.getElementById('widthInput').value = "296";
                    break;
                case 2:
                    document.getElementById('heightInput').value = "400";
                    document.getElementById('widthInput').value = "300";
                    break;
                case 3:
                    document.getElementById('heightInput').value = "384";
                    document.getElementById('widthInput').value = "640";
                    break;
                case 4:
                    document.getElementById('heightInput').value = "640";
                    document.getElementById('widthInput').value = "960";
                    break;
                case 5:
                    document.getElementById('heightInput').value = "132";
                    document.getElementById('widthInput').value = "250";
                    break;
                case 6:
                    document.getElementById('heightInput').value = "96";
                    document.getElementById('widthInput').value = "196";
                    break;
                case 7:
                    document.getElementById('heightInput').value = "480";
                    document.getElementById('widthInput').value = "640";
                    break;
                case 8:
                    document.getElementById('heightInput').value = "128";
                    document.getElementById('widthInput').value = "250";
                    break;
                case 9:
                    document.getElementById('heightInput').value = "800";
                    document.getElementById('widthInput').value = "480";
                    break;
                case 10:
                    document.getElementById('heightInput').value = "480";
                    document.getElementById('widthInput').value = "280";
                    break;
            }

            switch (dispPtype) {
                case 0:// TFT
                    document.getElementById('mirrorCheckbox').checked = false;
                    document.getElementById('tftCheckbox').checked = true;
                    break;
                case 1:// EPA
                    document.getElementById('mirrorCheckbox').checked = false;
                    document.getElementById('tftCheckbox').checked = false;
                    break;
                case 2:// EPA1
                    document.getElementById('mirrorCheckbox').checked = false;
                    document.getElementById('tftCheckbox').checked = false;
                    break;
                case 3:// EPA2
                    document.getElementById('mirrorCheckbox').checked = false;
                    document.getElementById('tftCheckbox').checked = false;
                    break;
            }
            switch (availColors) {
                case 0:// BW
                    document.getElementById('secondColorCheckbox').checked = false;
                    document.getElementById('redSlider').disabled = true;
                    break;
                case 1:// BWR
                    document.getElementById('secondColorCheckbox').checked = true;
                    document.getElementById('redSlider').disabled = false;
                    break;
                case 2:// BWY
                    document.getElementById('secondColorCheckbox').checked = true;
                    document.getElementById('redSlider').disabled = false;
                    break;
                case 3:// BWRY
                    document.getElementById('secondColorCheckbox').checked = true;
                    document.getElementById('redSlider').disabled = false;
                    break;
                case 4:// BWRGBYO
                    document.getElementById('secondColorCheckbox').checked = true;
                    document.getElementById('redSlider').disabled = false;
                    break;
            }
            switch (singleDoubleMirror) {
                case 0:// Single image
                    break;
                case 1:// 2 Images
                    break;
            }
        },
        /* displayOverlay() : ì›ë³¸ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ì´ìš©í•´
           - bwData: luminance ê¸°ì¤€ (luminance > lumThreshold â†’ í°ìƒ‰, ì•„ë‹ˆë©´ ê²€ì •)
           - redOverlayData: (r > redThreshold && g < redThreshold)ì´ë©´ ë¹¨ê°•, ì•„ë‹ˆë©´ íˆ¬ëª…
           ìµœì¢… í•©ì„±í•˜ì—¬ ìº”ë²„ìŠ¤ì— ì¶œë ¥í•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ pixelDataì— í—¥ìŠ¤ ë¬¸ìì—´ë¡œ ì €ì¥
        */
        displayOverlay() {
          if (!this.originalImageData) return;
          const width = this.canvas.width;
          const height = this.canvas.height;
          const origData = this.originalImageData;
          const bwData = this.ctx.createImageData(width, height);
          const redOverlayData = this.ctx.createImageData(width, height);
          const finalData = this.ctx.createImageData(width, height);

          // ìŠ¬ë¼ì´ë” ê°’ ì½ê¸°
          const lumThreshold = parseInt(document.getElementById('luminanceSlider').value);
          const redThreshold = parseInt(document.getElementById('redSlider').value);
          var secondColorEnabled = document.getElementById('secondColorCheckbox').checked;

          for (let i = 0; i < origData.data.length; i += 4) {
            const r = origData.data[i];
            const g = origData.data[i + 1];
            const b = origData.data[i + 2];

            // í‘ë°± ì´ì§„í™” (luminance ê¸°ì¤€)
            const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;
            if (luminance > lumThreshold) {
              bwData.data[i]     = 255;
              bwData.data[i + 1] = 255;
              bwData.data[i + 2] = 255;
              bwData.data[i + 3] = 255;
            } else {
              bwData.data[i]     = 0;
              bwData.data[i + 1] = 0;
              bwData.data[i + 2] = 0;
              bwData.data[i + 3] = 255;
            }

            // ë¹¨ê°• ì˜¤ë²„ë ˆì´: r > redThreshold && g < redThresholdì´ë©´ ë¹¨ê°•, ì•„ë‹ˆë©´ íˆ¬ëª…
            if (secondColorEnabled && r > redThreshold && g < redThreshold) {
              redOverlayData.data[i]     = 255;
              redOverlayData.data[i + 1] = 0;
              redOverlayData.data[i + 2] = 0;
              redOverlayData.data[i + 3] = 255;
            } else {
              redOverlayData.data[i]     = 0;
              redOverlayData.data[i + 1] = 0;
              redOverlayData.data[i + 2] = 0;
              redOverlayData.data[i + 3] = 0;
            }

            // ìµœì¢… í•©ì„±: ë¹¨ê°• ì˜¤ë²„ë ˆì´ê°€ ì ìš©ëœ í”½ì…€ì€ ë¹¨ê°•, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ bwData
            if (redOverlayData.data[i + 3] > 0) {
              finalData.data[i]     = redOverlayData.data[i];
              finalData.data[i + 1] = redOverlayData.data[i + 1];
              finalData.data[i + 2] = redOverlayData.data[i + 2];
              finalData.data[i + 3] = 255;
            } else {
              finalData.data[i]     = bwData.data[i];
              finalData.data[i + 1] = bwData.data[i + 1];
              finalData.data[i + 2] = bwData.data[i + 2];
              finalData.data[i + 3] = 255;
            }
          }

          this.ctx.clearRect(0, 0, width, height);
          this.ctx.putImageData(finalData, 0, 0);
          this.getPixelData();
        },
        
        getPixelData() {
            if (document.getElementById('ditherrin').checked)
                applyDithering();
            var compressionEnabled = document.getElementById('compressionCheckbox').checked;
            var secondColorEnabled = document.getElementById('secondColorCheckbox').checked;
            var mirrorEnabled = document.getElementById('mirrorCheckbox').checked;
            var tftEnabled = document.getElementById('tftCheckbox').checked;
            var canvas = document.getElementById('myCanvas');
            var ctx = canvas.getContext('2d');
            var width = canvas.width;
            var height = canvas.height;
            var imageData = ctx.getImageData(0, 0, width, height);
            // ìŠ¬ë¼ì´ë” ê°’ ì½ê¸°
            const lumThreshold = parseInt(document.getElementById('luminanceSlider').value);
            const redThreshold = parseInt(document.getElementById('redSlider').value);
            let originalCanvas = document.createElement("canvas");
            let originalCtx = originalCanvas.getContext("2d");
            originalCanvas.width = canvas.width;
            originalCanvas.height = canvas.height;
            originalCtx.putImageData(imageData, 0, 0);

            if (tftEnabled) {
                var tempCanvas = document.createElement('canvas');
                var tempCtx = tempCanvas.getContext('2d');
                width = canvas.width / 2;
                height = canvas.height * 2;
                tempCanvas.width = width;
                tempCanvas.height = height;

                // 4. ì›ë³¸ ìº”ë²„ìŠ¤ë¥¼ ìƒˆë¡œìš´ í¬ê¸°ë¡œ ê·¸ë¦¬ê¸° (ë¦¬ì‚¬ì´ì§•)
                tempCtx.drawImage(originalCanvas, 0, 0, imageData.width, imageData.height, 0, 0, width, height);

                // 5. ë¦¬ì‚¬ì´ì¦ˆëœ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ë°˜í™˜
                imageData = tempCtx.getImageData(0, 0, width, height);
            }

            if (mirrorEnabled) {
                var tempCanvas = document.createElement('canvas');
                var tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = width;
                tempCanvas.height = height;

                tempCtx.translate(width, 0);
                tempCtx.scale(-1, 1);
                tempCtx.drawImage(originalCanvas, 0, 0, width, height);
                imageData = tempCtx.getImageData(0, 0, width, height);
            }

            var pixels = imageData.data;
            var byteData = [];
            var byteDataRed = [];
            var currentByte = 0;
            var currentByteRed = 0;
            var bitPosition = 7;
            for (var x = 0; x < width; x++) {
                for (var y = 0; y < height; y++) {
                    var curr = (Math.round(y * width) + x) * 4;
                    var r = pixels[curr];
                    var g = pixels[curr + 1];
                    var b = pixels[curr + 2];
                    var luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                    if (luminance > lumThreshold) {
                        currentByte |= (1 << bitPosition);
                    }
                    if (r > redThreshold && g < redThreshold) {
                        currentByteRed |= (1 << bitPosition);
                    }
                    bitPosition--;
                    if (bitPosition < 0) {
                        byteData.push(currentByte);
                        byteDataRed.push(currentByteRed);
                        currentByte = 0;
                        currentByteRed = 0;
                        bitPosition = 7;
                    }
                }
            }

            if (bitPosition !== 7) {
                byteData.push(currentByte);
                byteDataRed.push(currentByteRed);
            }

            var byteDataCompressed = [];
            var pixelDataTextarea = document.getElementById('pixelData');

            if (compressionEnabled) {
                var currentPosi = 0;
                var byte_per_line = height / 8;
                byteDataCompressed.push(0x00);
                byteDataCompressed.push(0x00);
                byteDataCompressed.push(0x00);
                byteDataCompressed.push(0x00);
                for (var i = 0; i < width; i += 1) {
                    byteDataCompressed.push(0x75);
                    byteDataCompressed.push(byte_per_line + 7);
                    byteDataCompressed.push(byte_per_line);
                    byteDataCompressed.push(0x00);
                    byteDataCompressed.push(0x00);
                    byteDataCompressed.push(0x00);
                    byteDataCompressed.push(0x00);
                    for (var b = 0; b < byte_per_line; b++) {
                        byteDataCompressed.push(byteData[currentPosi++]);
                    }
                }
                if (secondColorEnabled) {
                    for (var i = 0; i < width; i += 1) {
                        byteDataCompressed.push(0x75);
                        byteDataCompressed.push(byte_per_line + 7);
                        byteDataCompressed.push(byte_per_line);
                        byteDataCompressed.push(0x00);
                        byteDataCompressed.push(0x00);
                        byteDataCompressed.push(0x00);
                        byteDataCompressed.push(0x00);
                        for (var b = 0; b < byte_per_line; b++) {
                            byteDataCompressed.push(byteData[currentPosi++]);
                        }
                    }
                }
                byteDataCompressed[0] = byteDataCompressed.length & 0xff;
                byteDataCompressed[1] = (byteDataCompressed.length >> 8) & 0xff;
                byteDataCompressed[2] = (byteDataCompressed.length >> 16) & 0xff;
                byteDataCompressed[3] = (byteDataCompressed.length >> 24) & 0xff;
            } else {
                for (var b = 0; b < byteData.length; b++) {
                    byteDataCompressed.push(byteData[b]);
                }
                if (secondColorEnabled) {
                    byteDataCompressed = [...byteDataCompressed, ...byteDataRed];
                }
            }
            pixelDataTextarea.value = Utils.bufferToHex(byteDataCompressed);
        },
        /* ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê³  ì €ì¥ */
        drawImage(img) {
          this.image = img;  // ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
          const canvasW = this.canvas.width;
          const canvasH = this.canvas.height;
          // ê¸°ë³¸ ìŠ¤ì¼€ì¼ì€ ìº”ë²„ìŠ¤ì— ê½‰ ì°¨ê²Œ ê³„ì‚°
          const scale = Math.max(canvasW / img.width, canvasH / img.height);
          this.scale = scale;
          this.newW = img.width * scale;
          this.newH = img.height * scale;
          // ì´ˆê¸° ì˜¤í”„ì…‹ì€ ì¤‘ì•™ ì •ë ¬
          this.offsetX = (canvasW - this.newW) / 2;
          this.offsetY = (canvasH - this.newH) / 2;
          // ì´ë¯¸ì§€ ë Œë”ë§(ì˜¤ë²„ë ˆì´ í¬í•¨)
          this.render();
        },
        // render() í•¨ìˆ˜: í˜„ì¬ ì˜¤í”„ì…‹ê³¼ ìŠ¤ì¼€ì¼ì„ ë°˜ì˜í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
        render() {
          const canvasW = this.canvas.width;
          const canvasH = this.canvas.height;
          this.ctx.clearRect(0, 0, canvasW, canvasH);
          this.ctx.fillStyle = 'white';
          this.ctx.fillRect(0, 0, canvasW, canvasH);
          // ì €ì¥ëœ ì´ë¯¸ì§€ì™€ í˜„ì¬ ì˜¤í”„ì…‹, í¬ê¸°ë¥¼ ì´ìš©í•´ ì´ë¯¸ì§€ë¥¼ ê·¸ë¦½ë‹ˆë‹¤.
          this.ctx.drawImage(this.image, this.offsetX, this.offsetY, this.newW, this.newH);
          // ì˜¤ë²„ë ˆì´ ì²˜ë¦¬ë¥¼ ìœ„í•´ í˜„ì¬ ìº”ë²„ìŠ¤ì˜ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ì €ì¥í•œ í›„ displayOverlay() í˜¸ì¶œ
          this.originalImageData = this.ctx.getImageData(0, 0, canvasW, canvasH);
          this.displayOverlay();
        },
        applyDithering() {
          const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
          const data = imageData.data;
          for (let i = 0; i < data.length; i += 4) {
            const oldR = data[i], oldG = data[i + 1], oldB = data[i + 2];
            const [newR, newG, newB] = this.findNearestColor(oldR, oldG, oldB);
            data[i] = newR; 
            data[i + 1] = newG; 
            data[i + 2] = newB;
            const errR = oldR - newR, errG = oldG - newG, errB = oldB - newB;
            const distributeError = (index, factor) => {
              if (index < 0 || index >= data.length) return;
              data[index] = Utils.clamp(data[index] + errR * factor);
              data[index + 1] = Utils.clamp(data[index + 1] + errG * factor);
              data[index + 2] = Utils.clamp(data[index + 2] + errB * factor);
            };
            if (i + 4 < data.length) distributeError(i + 4, 7 / 16);
            const nextLine = i + 4 * this.canvas.width;
            if (nextLine < data.length) {
              distributeError(nextLine - 4, 3 / 16);
              distributeError(nextLine, 5 / 16);
              if (nextLine + 4 < data.length) distributeError(nextLine + 4, 1 / 16);
            }
          }
          this.ctx.putImageData(imageData, 0, 0);
        },
        findNearestColor(r, g, b) {
          if (r > 128 && g < 128 && b < 128) return [255, 0, 0];
          const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;
          return luminance < 85 ? [0, 0, 0] : [255, 255, 255];
        }
      };

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë¼ë²¨(íŒŒë¼ë¯¸í„°) ê´€ë¦¬ (í•„ìš” ì‹œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      const LabelManager = {
        updateParameters() {
          // ë¼ë²¨ ì„ íƒ ì‹œ í•„ìš”í•œ ë™ì‘ (ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ ìº”ë²„ìŠ¤ ê°±ì‹ )
          CanvasManager.decodeTypes();
          CanvasManager.initCanvas();
          CanvasManager.displayOverlay();
        }
      };

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BLE ê´€ë¦¬ (í•„ìš” ì‹œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      const BLEManager = {
        bleDevice: null,
        gattServer: null,
        bleService: null,
        writeChar: null,
        writeImageChar: null,
        reconnectAttempts: 0,
        imgHexData: "",
        imgHexLength: 0,
        uploadPartIndex: 0,
        checkSupport() {
          if (!navigator.bluetooth) {
            document.getElementById("ble-support").innerHTML = "í•´ë‹¹ ë¸Œë¼ìš°ì €ëŠ” Web Bluetoothë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nPC Chrome ë¸Œë¼ìš°ì € ì—ì„œ ì‹œë„í•˜ì„¸ìš”";
            document.getElementById("connectButton").disabled = true;
          }
        },
        reset() {
          this.gattServer = null;
          this.bleService = null;
          this.writeChar = null;
          this.writeImageChar = null;
          this.imgHexData = "";
          this.imgHexLength = 0;
          this.uploadPartIndex = 0;
        },
        async sendCommand(cmd) {
          if (this.writeChar) {
            try {
              await this.writeChar.writeValue(cmd);
            } catch (e) {
              addLog("GATT operation in progress. ì¬ì‹œë„...");
              await new Promise(resolve => setTimeout(resolve, 500));
              await this.writeChar.writeValue(cmd);
            }
          }
        },
        async sendCommandHex(cmdHex) {
          const cmd = Utils.hexToBytes(cmdHex);
          addLog('ì†¡ì‹  ë°ì´í„° : ' + cmdHex);
          await this.sendCommand(cmd);
        },
        async sendImageCommand(cmd) {
          if (this.writeImageChar) {
            try {
              await this.writeImageChar.writeValue(cmd);
            } catch (e) {
              addLog("GATT operation in progress. ì¬ì‹œë„...");
              await new Promise(resolve => setTimeout(resolve, 500));
              await this.writeImageChar.writeValue(cmd);
            }
          }
        },
        sendImageData() {
          imgData = document.getElementById('pixelData').value
          this.imgHexData = imgData.replace(/(?:\r\n|\r|\n|,|0x| )/g, '');
          this.imgHexLength = this.imgHexData.length;
          this.uploadPartIndex = 0;
          addLog("ì´ë¯¸ì§€ ì—…ë¡œë“œ");
          setStatus("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘");
          this.sendCommandHex("01");
        },
        handleImageState(dataHex) {
          switch (dataHex.substring(0, 2)) {
            case "01":
              if (dataHex === "01f400")
                this.sendCommandHex("02" + Utils.intToHex(this.imgHexLength / 2) + "000000");
              else
                addLog("ìƒˆë¡œìš´ ì´ë¯¸ì§€ ì „ì†¡ì„ ìœ„í•´ ì¬ì—°ê²°í•˜ì„¸ìš”.");
              break;
            case "02":
              addLog("ì´ë¯¸ì§€ ì „ì†¡ ë‹¨ê³„ 3 ì§„í–‰ ì¤‘");
              this.sendCommandHex("03");
              break;
            case "05":
              if (dataHex.substring(2, 4) === "08") {
                addLog("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ");
                setStatus("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ");
                if (this.gattServer && this.gattServer.connected) {
                  if (this.bleDevice && this.bleDevice.gatt.connected)
                    this.bleDevice.gatt.disconnect();
                    this.disconnect();
                }
              } else if (dataHex.substring(2, 4) !== "00") {
                addLog("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ, ì „ì†¡ ì¤‘ë‹¨!");
              } else {
                this.sendNextImagePart(dataHex.substring(4, 12));
              }
              break;
          }
        },
        sendNextImagePart(partAckHex) {
          if (this.imgHexData.length > 0) {
            let currentPartHex = "";
            console.log("PartACK: " + partAckHex + " PartUpload: " + Utils.intToHex(this.uploadPartIndex));
            if (partAckHex === Utils.intToHex(this.uploadPartIndex)) {
              currentPartHex = Utils.intToHex(this.uploadPartIndex) + this.imgHexData.substring(0, 480);
              this.imgHexData = this.imgHexData.substring(480);
              this.uploadPartIndex++;
            } else {
              addLog("ì˜¤ë¥˜ ë°œìƒ, ë§ˆì§€ë§‰ ë¶€ë¶„ ì¬ì „ì†¡");
              currentPartHex = Utils.intToHex(this.uploadPartIndex) + this.imgHexData.substring(0, 480);
            }
            console.log('Current Part: ' + currentPartHex);
            this.sendImageCommand(Utils.hexToBytes(currentPartHex));
          } else {
            addLog("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ");
          }
        },
        disconnect() {
          this.reset();
          addLog('ì—°ê²° í•´ì œë¨.');
          document.getElementById("connectButton").disabled = false;
        },
        handleNotification(data) {
          addLog("ìˆ˜ì‹  ë°ì´í„° : " + Utils.bytesToHex(data.buffer));
          setTimeout(() => this.handleImageState(Utils.bytesToHex(data.buffer)), 50);
        },
        initiateConnection() {
          document.getElementById("log").innerHTML = '';
          document.getElementById("connectButton").disabled = true;
          setStatus("ë¼ë²¨ ì„ íƒì¤‘...");
          if (this.gattServer && this.gattServer.connected) {
            if (this.bleDevice && this.bleDevice.gatt.connected) this.bleDevice.gatt.disconnect();
            document.getElementById("connectButton").disabled = false;
          } else {
            this.reconnectAttempts = 0;
            navigator.bluetooth.requestDevice({
              filters: [
                { manufacturerData: [{ companyIdentifier: 0x5053 }] }
              ],
              optionalServices: [0xFEF0]
            }).then(device => {
              setStatus("ì—°ê²°ì¤‘ : " + device.name);
              device.addEventListener('gattserverdisconnected', () => this.disconnect());
              this.bleDevice = device;
              this.connect();
            }).catch(handleBLEError);
          }
        },
        reConnect() {
          this.reconnectAttempts = 0;
          if (this.bleDevice && this.bleDevice.gatt.connected)
            this.bleDevice.gatt.disconnect();
          this.reset();
          addLog("ì¬ì—°ê²° ì‹œë„");
          setTimeout(() => this.connect(), 300);
        },
        connect() {
          if (!this.writeChar) {
            addLog("ì—°ê²°ì¤‘ : " + this.bleDevice.name);
            this.bleDevice.gatt.connect().then(server => {
              this.gattServer = server;
              return this.gattServer.getPrimaryService(0xFEF0);
            }).then(service => {
              this.bleService = service;
              return this.bleService.getCharacteristic(0xFEF2);
            }).then(characteristic => {
              this.writeImageChar = characteristic;
              return this.bleService.getCharacteristic(0xFEF1);
            }).then(characteristic => {
              this.writeChar = characteristic;
              setTimeout(() => this.sendImageData(), 1000);
              return this.writeChar.startNotifications().then(() => {
                this.writeChar.addEventListener('characteristicvaluechanged', event => {
                  this.handleNotification(event.target.value);
                });
              });
            }).catch(handleBLEError);
          }
        },
      }
      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BLE ìƒíƒœ ë° ë¡œê·¸ í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      function setStatus(statusText) {
        document.getElementById("status").innerHTML = statusText;
      }
      function addLog(logText) {
        const now = new Date();
        const time = ("0" + now.getHours()).slice(-2) + ":" +
                     ("0" + now.getMinutes()).slice(-2) + ":" +
                     ("0" + now.getSeconds()).slice(-2) + " : ";
        document.getElementById("log").innerHTML += time + logText + '<br>';
        console.log(time + logText);
        while ((document.getElementById("log").innerHTML.match(/<br>/g) || []).length > 100) {
          const firstBreak = document.getElementById("log").innerHTML.indexOf("<br>");
          document.getElementById("log").innerHTML = document.getElementById("log").innerHTML.substring(firstBreak + 4);
        }
      }
      function handleBLEError(error) {
        console.error(error);
        setStatus("ì—ëŸ¬ : " + error);
        BLEManager.disconnect();
        if (BLEManager.bleDevice && BLEManager.bleDevice.gatt.connected) {
          BLEManager.bleDevice.gatt.disconnect();
        }
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      document.getElementById('themeToggle').addEventListener('click', ThemeManager.toggleTheme);
      document.getElementById('optionsSelect').addEventListener('change', () => {
        LabelManager.updateParameters();
      });
      document.getElementById('imageUpload').addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
              CanvasManager.drawImage(img);
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
      // ìŠ¬ë¼ì´ë” ì´ë™ ì‹œ ì‹¤ì‹œê°„ ê²°ê³¼ ê°±ì‹ 
      document.getElementById('luminanceSlider').addEventListener('input', function() {
        document.getElementById('lumVal').textContent = this.value;
        CanvasManager.displayOverlay();
      });
      document.getElementById('redSlider').addEventListener('input', function() {
        document.getElementById('redVal').textContent = this.value;
        CanvasManager.displayOverlay();
      });
      document.getElementById('pixlrButton').addEventListener('click', function() {
        window.open('https://pixlr.com/kr/editor/', '_blank');
      });
      document.getElementById('connectButton').addEventListener('click', () => {
        BLEManager.initiateConnection();
      });
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      window.onload = function() {
        LabelManager.updateParameters();
        BLEManager.checkSupport();
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìº”ë²„ìŠ¤ ë“œë˜ê·¸, ì»¤ì„œ ë³€ê²½ ë° í™•ëŒ€/ì¶•ì†Œ ê¸°ëŠ¥ ì¶”ê°€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      (function() {
        const canvas = CanvasManager.canvas;
        let isDragging = false;
        let startX, startY;

        // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì´ë™ ê°€ëŠ¥í•œ ì»¤ì„œë¡œ ë³€ê²½
        canvas.addEventListener('mouseenter', () => {
          canvas.style.cursor = "grab";
        });
        canvas.addEventListener('mouseleave', () => {
          canvas.style.cursor = "default";
          isDragging = false;
        });

        canvas.addEventListener('mousedown', (e) => {
          isDragging = true;
          startX = e.offsetX;
          startY = e.offsetY;
          canvas.style.cursor = "grabbing";
        });

        canvas.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          // ë“œë˜ê·¸í•œ ê±°ë¦¬ ê³„ì‚°
          const dx = e.offsetX - startX;
          const dy = e.offsetY - startY;
          // CanvasManagerì˜ ì˜¤í”„ì…‹ ì—…ë°ì´íŠ¸
          CanvasManager.offsetX += dx;
          CanvasManager.offsetY += dy;
          // ì‹œì‘ ì¢Œí‘œ ê°±ì‹ 
          startX = e.offsetX;
          startY = e.offsetY;
          // ìƒˆ ì˜¤í”„ì…‹ì— ë§ê²Œ ë‹¤ì‹œ ë Œë”ë§
          CanvasManager.render();
        });

        canvas.addEventListener('mouseup', () => {
          isDragging = false;
          canvas.style.cursor = "grab";
        });
        
        // ë§ˆìš°ìŠ¤ íœ  ì´ë²¤íŠ¸: í™•ëŒ€/ì¶•ì†Œ
        canvas.addEventListener('wheel', (e) => {
          e.preventDefault();
          const zoomFactor = 1.1;
          const oldScale = CanvasManager.scale;
          let newScale;
          if (e.deltaY < 0) {  // í™•ëŒ€
            newScale = oldScale * zoomFactor;
          } else {             // ì¶•ì†Œ
            newScale = oldScale / zoomFactor;
          }
          // í˜„ì¬ ë§ˆìš°ìŠ¤ ì¢Œí‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í™•ëŒ€/ì¶•ì†Œ
          const rect = canvas.getBoundingClientRect();
          const mouseX = e.clientX - rect.left;
          const mouseY = e.clientY - rect.top;
          // ì´ë¯¸ì§€ ìƒì˜ ì¢Œí‘œ (ê¸°ì¡´ ìŠ¤ì¼€ì¼ ê¸°ì¤€)
          const imageX = (mouseX - CanvasManager.offsetX) / oldScale;
          const imageY = (mouseY - CanvasManager.offsetY) / oldScale;
          // ìƒˆë¡œìš´ ìŠ¤ì¼€ì¼ ì ìš©
          CanvasManager.scale = newScale;
          CanvasManager.newW = CanvasManager.image.width * newScale;
          CanvasManager.newH = CanvasManager.image.height * newScale;
          // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ê°€ ì´ë¯¸ì§€ ë‚´ ë™ì¼ ìœ„ì¹˜ê°€ ë˜ë„ë¡ ì˜¤í”„ì…‹ ë³´ì •
          CanvasManager.offsetX = mouseX - imageX * newScale;
          CanvasManager.offsetY = mouseY - imageY * newScale;
          CanvasManager.render();
        });
      })();
    })();
  </script>
</body>
</html>
